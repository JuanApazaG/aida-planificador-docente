# FLUJO COMPLETO CON PRINTS PARA DEBUG

## üîç FLUJO DE EJECUCI√ìN CON PRINTS

### 1. **PAT UPLOAD** - `src/components/PATUpload.tsx`

```typescript
// L√çNEA 67-125: handleGeneratePDC()
console.log('=== INICIANDO GENERACI√ìN PDC ===');
console.log('Nombre del archivo:', fileName);
console.log('Preview URL:', previewUrl);

// L√çNEA 92: Detalles del archivo
console.log('Archivo obtenido del input:', file);
console.log('Detalles del archivo:');
console.log('- Nombre:', file.name);
console.log('- Tama√±o:', file.size, 'bytes');
console.log('- Tipo:', file.type);
console.log('- √öltima modificaci√≥n:', file.lastModified);

// L√çNEA 105: Env√≠o al backend
console.log('Enviando archivo al backend:', file.name, file.size);
const uploadResult = await apiService.uploadPAT(file);
console.log('Respuesta del backend:', uploadResult);

// L√çNEA 107: Verificaci√≥n de √©xito
if (!uploadResult.success) {
  throw new Error(uploadResult.error || "Error al subir el archivo");
}

// L√çNEA 115: Datos extra√≠dos
console.log('‚úÖ Datos del PAT extra√≠dos y guardados exitosamente');
console.log('üìÑ Datos extra√≠dos:', uploadResult.extractedData);

// L√çNEA 120: Navegaci√≥n
console.log('üöÄ Navegando a configuraci√≥n de PDC...');
window.location.href = '/configurar-pdc';
```

### 2. **BACKEND UPLOAD** - `src/config/backend.ts`

```typescript
// L√çNEA 96-170: apiService.uploadPAT()
console.log('=== INICIANDO UPLOAD PAT ===');
console.log('Archivo:', file.name, 'Tama√±o:', file.size, 'Tipo:', file.type);

// L√çNEA 107: FormData
console.log('FormData creado, verificando contenido:');
for (const [key, value] of formData.entries()) {
  console.log('Key:', key, 'Value:', value);
}

// L√çNEA 112: URL del endpoint
console.log('URL del endpoint:', `${BACKEND_CONFIG.BASE_URL}${BACKEND_CONFIG.ENDPOINTS.UPLOAD_PAT}`);

// L√çNEA 120: Respuesta del servidor
console.log('Respuesta del servidor:');
console.log('Status:', response.status);
console.log('StatusText:', response.statusText);
console.log('Headers:', Object.fromEntries(response.headers.entries()));

// L√çNEA 129: Body de la respuesta
console.log('Body de la respuesta:', responseText);

// L√çNEA 136: Parseo JSON
console.log('‚úÖ Datos JSON parseados correctamente');

// L√çNEA 140: Guardado en localStorage
localStorage.setItem('patExtractedData', JSON.stringify(extractedData));
console.log('‚úÖ Datos guardados en localStorage');

// L√çNEA 150: Upload exitoso
console.log('‚úÖ Upload exitoso');
```

### 3. **LOAD REFERENTIAL DATA** - `src/components/PDCConfigForm.tsx`

```typescript
// L√çNEA 73-136: loadReferentialData()
console.log('üîÑ Cargando datos referenciales...');

// L√çNEA 75: Verificar datos guardados
const savedPATData = localStorage.getItem('patExtractedData');
if (savedPATData) {
  const patData = JSON.parse(savedPATData);
  console.log('üìÑ Usando datos del PAT guardado:', patData);
  
  // L√çNEA 78: Extraer datos personales
  const datosPersonales = patData.datosPersonales || {};
  console.log('üë§ Datos personales extra√≠dos:', datosPersonales);
  
  // L√çNEA 79-87: Configurar datos referenciales
  setReferentialData({
    unidadEducativa: datosPersonales.unidadEducativa || "RAFAEL CAMPOS DE LUJE",
    distritoEducativo: datosPersonales.distritoEducativo || "POROMA",
    departamento: datosPersonales.departamento || "CHUQUISACA",
    gestion: datosPersonales.gestion || "2025",
    anioEscolaridad: datosPersonales.anioEscolaridad || "2DO A 6TO DE SECUNDARIA",
    maestro: datosPersonales.maestro || "PAOLA MONDOCORRE",
    tituloPSP: datosPersonales.tituloPSP || "EL HUERTO ESCOLAR UN ESPACIO PARA CONSTRUIR PAZ"
  });
  console.log('‚úÖ Datos referenciales configurados desde PAT');
} else {
  console.log('‚ö†Ô∏è No se encontraron datos del PAT, usando valores por defecto');
}
```

### 4. **TRIMESTRE SELECTION** - `src/components/PDCConfigForm.tsx`

```typescript
// L√çNEA 137-157: handleTrimestreSelect()
console.log('üéØ === SELECCI√ìN DE TRIMESTRE ===');
console.log('Trimestre seleccionado:', trimestre);

// L√çNEA 140: Guardar en localStorage
localStorage.setItem('selectedTrimestre', trimestre);
console.log('üíæ Trimestre guardado en localStorage:', trimestre);

// L√çNEA 142: Log con jsonLogger
import('../utils/jsonLogger').then(({ jsonLogger }) => {
  jsonLogger.logUserSelections(trimestre);
});

// L√çNEA 145: Navegar al siguiente paso
console.log('‚û°Ô∏è Navegando al siguiente paso...');
setCurrentStep(2);
```

### 5. **GRADO SELECTION** - `src/components/PDCConfigForm.tsx`

```typescript
// L√çNEA 158-178: handleGradoSelect()
console.log('üéì === SELECCI√ìN DE GRADO ===');
console.log('Grado seleccionado:', grado);

// L√çNEA 161: Guardar en localStorage
localStorage.setItem('selectedGrado', grado);
console.log('üíæ Grado guardado en localStorage:', grado);

// L√çNEA 164: Log con jsonLogger
import('../utils/jsonLogger').then(({ jsonLogger }) => {
  jsonLogger.logUserSelections(selectedTrimestre, grado);
});

// L√çNEA 167: Navegar al siguiente paso
console.log('‚û°Ô∏è Navegando al siguiente paso...');
setCurrentStep(3);
```

### 6. **FORM SUBMISSION** - `src/components/PDCConfigForm.tsx`

```typescript
// L√çNEA 179-270: onSubmit()
console.log('‚úÖ Formulario enviado con datos:', data);
console.log('üìù Contenidos a ense√±ar seleccionados:', data.contenidosAEnsenar);

// L√çNEA 185: Obtener datos del PAT
const savedPATData = localStorage.getItem('patExtractedData');
const patData = savedPATData ? JSON.parse(savedPATData) : {};
console.log('üìÑ Datos del PAT recuperados:', patData);

// L√çNEA 187-220: Preparar datos completos
const completeDataForGeneration = {
  datosPersonales: {
    objetivoHolisticoDeNivel: patData.datosPersonales?.objetivoHolisticoDeNivel || "",
    unidadEducativa: patData.datosPersonales?.unidadEducativa || "",
    maestro: patData.datosPersonales?.maestro || "",
    tituloPSP: patData.datosPersonales?.tituloPSP || "",
    anioEscolaridad: patData.datosPersonales?.anioEscolaridad || "",
    departamento: patData.datosPersonales?.departamento || "",
    gestion: patData.datosPersonales?.gestion || "",
    distritoEducativo: patData.datosPersonales?.distritoEducativo || "",
    PlanAnualTrimestralizado: patData.datosPersonales?.PlanAnualTrimestralizado || []
  },
  configuracionUsuario: {
    trimestreSeleccionado: data.trimestre,
    gradoSeleccionado: data.grado,
    contenidosSeleccionados: data.contenidosAEnsenar || [],
    mesSeleccionado: data.mes,
    recursos: data.recursos || "",
    orientacionesPractica: data.orientacionesPractica || "",
    orientacionesTeoria: data.orientacionesTeoria || "",
    orientacionesValoracion: data.orientacionesValoracion || "",
    orientacionesProduccion: data.orientacionesProduccion || ""
  },
  metadatos: {
    fileId: fileId,
    fechaCreacion: new Date().toISOString(),
    estado: 'listo_para_generar'
  }
};

// L√çNEA 222-230: Debug logs
import('../utils/debugFlow').then(({ debugFlow }) => {
  debugFlow.logCompleteDataForGeneration(completeDataForGeneration);
});

import('../utils/jsonLogger').then(({ jsonLogger }) => {
  jsonLogger.logFinalJSON(completeDataForGeneration);
});

// L√çNEA 232-240: Mostrar en consola
console.log('üöÄ === DATOS PARA GENERAR PDC (ESTRUCTURA CORRECTA) ===');
console.log('üìä JSON completo que se enviar√°:');
console.log(JSON.stringify(completeDataForGeneration, null, 2));
console.log('üìù Resumen de datos:');
console.log('- Trimestre:', completeDataForGeneration.configuracionUsuario.trimestreSeleccionado);
console.log('- Grado:', completeDataForGeneration.configuracionUsuario.gradoSeleccionado);
console.log('- Contenidos seleccionados:', completeDataForGeneration.configuracionUsuario.contenidosSeleccionados.length, 'elementos');
console.log('- Mes:', completeDataForGeneration.configuracionUsuario.mesSeleccionado);
console.log('- T√≠tulo PSP:', completeDataForGeneration.datosPersonales.tituloPSP);
console.log('- Plan Trimestralizado:', completeDataForGeneration.datosPersonales.PlanAnualTrimestralizado.length, 'trimestres');

// L√çNEA 242: Guardar en localStorage
localStorage.setItem('pdcCompleteData', JSON.stringify(completeDataForGeneration));
console.log('üíæ Datos completos guardados en localStorage como "pdcCompleteData"');

// L√çNEA 245-250: Preparar datos para backend (‚ö†Ô∏è PROBLEMA)
const configData: PDCConfigData = {
  ...data,
  fileId: fileId,
};
console.log('‚ö†Ô∏è configData que se enviar√° (INCORRECTO):', configData);
console.log('‚úÖ completeDataForGeneration que NO se enviar√° (CORRECTO):', completeDataForGeneration);

// L√çNEA 255: Env√≠o al backend (‚ö†Ô∏è PROBLEMA)
const result = await apiService.submitPDCConfig(configData); // ‚ùå INCORRECTO
console.log('üì§ Resultado del env√≠o:', result);
```

### 7. **BACKEND SUBMIT** - `src/config/backend.ts`

```typescript
// L√çNEA 280-311: apiService.submitPDCConfig()
console.log('üì§ === ENVIANDO CONFIGURACI√ìN PDC ===');
console.log('Datos a enviar:', configData);
console.log('URL del endpoint:', `${BACKEND_CONFIG.BASE_URL}${BACKEND_CONFIG.ENDPOINTS.SUBMIT_PDC_CONFIG}`);

// L√çNEA 285-295: Request
const response = await fetch(`${BACKEND_CONFIG.BASE_URL}${BACKEND_CONFIG.ENDPOINTS.SUBMIT_PDC_CONFIG}`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(configData), // ‚ö†Ô∏è PROBLEMA: Env√≠a configData en lugar de completeDataForGeneration
  signal: AbortSignal.timeout(BACKEND_CONFIG.TIMEOUT),
});

// L√çNEA 297: Verificaci√≥n de respuesta
if (!response.ok) {
  throw new Error(`Error ${response.status}: ${response.statusText}`);
}

// L√çNEA 299: Parsear respuesta
const data = await response.json();
console.log('üì• Respuesta del backend:', data);

// L√çNEA 300: Retornar resultado
return { 
  success: true, 
  pdcId: data.pdcId,
  message: data.message 
};
```

---

## üö® PROBLEMAS IDENTIFICADOS EN EL FLUJO

### 1. **Env√≠o incorrecto de datos**
- **L√≠nea 255 en PDCConfigForm.tsx**: Se env√≠a `configData` en lugar de `completeDataForGeneration`
- **Impacto**: El backend recibe datos incompletos

### 2. **Filtrado no implementado**
- **PlanAnualTrimestralizado**: Se env√≠a todo el array en lugar de solo el trimestre seleccionado
- **Contenidos**: Se env√≠an todos los contenidos en lugar de solo los seleccionados

### 3. **Logs inconsistentes**
- Se guarda `completeDataForGeneration` pero se env√≠a `configData`
- Los logs muestran datos diferentes a los que se env√≠an

---

## üîß SOLUCIONES PARA IMPLEMENTAR

### 1. **Corregir env√≠o de datos**
```typescript
// En PDCConfigForm.tsx l√≠nea 255
// CAMBIAR:
const result = await apiService.submitPDCConfig(configData);

// POR:
const result = await apiService.submitPDCConfig(completeDataForGeneration);
```

### 2. **Implementar filtrado de trimestre**
```typescript
// En completeDataForGeneration, antes de la l√≠nea 220
const trimestreSeleccionado = data.trimestre;
const planFiltrado = patData.datosPersonales?.PlanAnualTrimestralizado?.filter(
  trimestre => trimestre.trimestre === trimestreSeleccionado
) || [];

// Cambiar l√≠nea 220:
PlanAnualTrimestralizado: planFiltrado
```

### 3. **Implementar filtrado de contenidos**
```typescript
// Despu√©s del filtrado de trimestre
const contenidosSeleccionados = data.contenidosAEnsenar || [];
const contenidosFiltrados = planFiltrado.map(trimestre => ({
  ...trimestre,
  contenidos: trimestre.contenidos?.filter(contenido => 
    contenidosSeleccionados.includes(contenido.tema)
  ) || []
}));

// Usar contenidosFiltrados en lugar de planFiltrado
```

---

## üìä COMANDOS PARA VER EL FLUJO

### Ver todos los logs en consola:
```javascript
// En la consola del navegador
import('./src/utils/jsonLogger').then(({ jsonLogger }) => {
  jsonLogger.showAllJSONs();
});
```

### Ver datos guardados:
```javascript
// En la consola del navegador
console.log('patExtractedData:', JSON.parse(localStorage.getItem('patExtractedData') || '{}'));
console.log('selectedTrimestre:', localStorage.getItem('selectedTrimestre'));
console.log('selectedGrado:', localStorage.getItem('selectedGrado'));
console.log('pdcCompleteData:', JSON.parse(localStorage.getItem('pdcCompleteData') || '{}'));
```

### Ver en la UI:
- Ir a `/json-viewer`
- Hacer clic en "Ver JSONs" en el header
